<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Redux-amrc by lewis617</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Redux-amrc</h1>
      <h2 class="project-tagline">Redux async middleware and reducer creator</h2>
      <a href="https://github.com/lewis617/redux-amrc" class="btn">View on GitHub</a>
      <a href="https://github.com/lewis617/redux-amrc/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/lewis617/redux-amrc/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="redux-async-middleware-and-reducer-creator" class="anchor" href="#redux-async-middleware-and-reducer-creator" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Redux async middleware and reducer creator</h1>

<p><a href="https://www.npmjs.com/package/redux-amrc"><img src="https://img.shields.io/npm/v/redux-amrc.svg?style=flat" alt="NPM Version"></a>
<a href="https://travis-ci.org/lewis617/redux-amrc"><img src="https://travis-ci.org/lewis617/redux-amrc.svg?branch=master" alt="Build Status"></a>
<a href="https://codecov.io/gh/lewis617/redux-amrc"><img src="https://codecov.io/gh/lewis617/redux-amrc/branch/master/graph/badge.svg" alt="codecov"></a>
<a href="redux-amrc"><img src="https://img.shields.io/npm/dm/redux-amrc.svg?maxAge=2592000" alt="npm"></a>
<a href="redux-amrc"><img src="https://img.shields.io/npm/l/redux-amrc.svg?maxAge=2592000" alt="npm"></a></p>

<p>This package will help you dispatch async action with less boilerplate.</p>

<h2>
<a id="install" class="anchor" href="#install" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Install</h2>

<pre><code>npm install redux-amrc --save
</code></pre>

<h2>
<a id="how-to-use" class="anchor" href="#how-to-use" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How to use</h2>

<p>store/configureStore.js</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">import</span> { <span class="pl-smi">asyncMiddleware</span> } <span class="pl-k">from</span> <span class="pl-s"><span class="pl-pds">'</span>redux-amrc<span class="pl-pds">'</span></span>;

<span class="pl-en">applyMiddleware</span>(thunk, asyncMiddleware)
</pre></div>

<p>reducers/index.js</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">import</span> { <span class="pl-smi">combineReducers</span> } <span class="pl-k">from</span> <span class="pl-s"><span class="pl-pds">'</span>redux<span class="pl-pds">'</span></span>;
<span class="pl-k">import</span> { <span class="pl-smi">reducerCreator</span> } <span class="pl-k">from</span> <span class="pl-s"><span class="pl-pds">'</span>redux-amrc<span class="pl-pds">'</span></span>;

<span class="pl-k">const</span> <span class="pl-c1">rootReducer</span> <span class="pl-k">=</span> <span class="pl-en">combineReducers</span>({
  async<span class="pl-k">:</span> <span class="pl-en">reducerCreator</span>()
});

<span class="pl-k">export</span> <span class="pl-v">default</span> <span class="pl-smi">rootReducer</span>;</pre></div>

<p>actions/index.js</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">import</span> { <span class="pl-smi">ASYNC</span> } <span class="pl-k">from</span> <span class="pl-s"><span class="pl-pds">'</span>redux-amrc<span class="pl-pds">'</span></span>;

<span class="pl-c">/**</span>
<span class="pl-c"> * This actionCreator will create LOAD and LOAD_SUCCESS,</span>
<span class="pl-c"> * state.async.[key] will be 'success'</span>
<span class="pl-c"> */</span>
<span class="pl-k">function</span> <span class="pl-en">success</span>() {
  <span class="pl-k">return</span> {
    [<span class="pl-c1">ASYNC</span>]<span class="pl-k">:</span> {
      key<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>key<span class="pl-pds">'</span></span>,
      <span class="pl-en">promise</span><span class="pl-k">:</span> () <span class="pl-k">=&gt;</span> <span class="pl-c1">Promise</span>.<span class="pl-en">resolve</span>(<span class="pl-s"><span class="pl-pds">'</span>success<span class="pl-pds">'</span></span>)
    }
  }
}

<span class="pl-c">/**</span>
<span class="pl-c"> * This actionCreator will create LOAD and LOAD_FAIL,</span>
<span class="pl-c"> * state.async.loadState.[key].error will be 'fail'</span>
<span class="pl-c"> */</span>
<span class="pl-k">function</span> <span class="pl-en">fail</span>() {
  <span class="pl-k">return</span> {
    [<span class="pl-c1">ASYNC</span>]<span class="pl-k">:</span> {
      key<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>key<span class="pl-pds">'</span></span>,
      <span class="pl-en">promise</span><span class="pl-k">:</span> () <span class="pl-k">=&gt;</span> <span class="pl-c1">Promise</span>.<span class="pl-en">reject</span>(<span class="pl-s"><span class="pl-pds">'</span>fail<span class="pl-pds">'</span></span>)
    }
  }
}</pre></div>

<p>If you want to add some code after async, you can just do this:</p>

<pre><code>dispatch(success())
  .then((action) =&gt; {
    console.log(action); // { payload: { data: 'success', key: 'key' }, type: '@async/LOAD_SUCCESS' }
  });

dispatch(fail())
  .then((action) =&gt; {
    console.log(action); // { payload: { error: 'fail', key: 'key' }, type: '@async/LOAD_FAIL' }
  });
</code></pre>

<p>If you want to add some code before async, you should write another action creator, because one function should do one thing.</p>

<pre><code>function loadData() {
  return {
    [ASYNC]: {
      key: 'data',
      promise: () =&gt; fetch('/api/data')
        .then((res) =&gt; {
          if (!res.ok) {
            throw new Error(res.statusText);
          }
          return res.json();
        })
    }
  };
}

function loadDataIfNeeded() {
  return (dispatch, getState) =&gt; {
    if (!getState().async.data) {
      dispatch(loadData())
    }
  };
}

</code></pre>

<p>If you don't like writing load*IfNeeded function, you can use "once" option to load data if needed.</p>

<pre><code>function loadData() {
  return {
    [ASYNC]: {
      key: 'data',
      promise: () =&gt; fetch('/api/data')
        .then((res) =&gt; {
          if (!res.ok) {
            throw new Error(res.statusText);
          }
          return res.json();
        })
      once: true
    }
  };
}
</code></pre>

<p>If you want to update data in in <code>state.async.[key]</code> with your own action and reducer, you should add <code>reducers</code> to <code>reducerCreator(reducers)</code>, <code>reducers</code> in <code>reducerCreator(reducers)</code> is same as <code>reducers</code> in <code>combineReducers(reducers)</code>:</p>

<pre><code>// your own action type
const TOGGLE = 'TOGGLE';

// your own reducer
function keyReducer(state, action) {
  switch (action.type) {
    case TOGGLE:
      return state === 'success' ? 'fail' : 'success';
    default:
      return state
  }

}

// add reducers to reducerCreator
const rootReducer = combineReducers({
  async: reducerCreator({
    key: keyReducer
  })
});

// This will toggle data in `state.async.key`
dispatch({ type: TOGGLE }); 
</code></pre>

<h2>
<a id="how-to-test" class="anchor" href="#how-to-test" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How to test</h2>

<p>If your action creator is like this:</p>

<pre><code>function loadData() {
  return {
    [ASYNC]: {
      key: 'data',
      promise: () =&gt; fetch('http://localhost:3000/api/data')
        .then((res) =&gt; {
          if (!res.ok) {
            throw new Error(res.statusText);
          }
          return res.json();
        })
    }
  };
}
</code></pre>

<p>The test should be like this:</p>

<pre><code>import expect from 'expect';
import configureStore from 'redux-mock-store';
import thunk from 'redux-thunk';
import { asyncMiddleware } from 'redux-amrc';
import { load, loadSuccess } from 'redux-amrc/lib/redux';
import nock from 'nock';
import { loadData } from '../your_action_file';

const middlewares = [thunk, asyncMiddleware];
const mockStore = configureStore(middlewares);
const data = { value: 'data' };

function setup(state = {}) {
  nock('http://localhost:3000')
    .get('/api/dga')
    .reply(200, data);
  return mockStore(state);
}

describe('data actions test', () =&gt; {
  afterEach(() =&gt; {
    nock.cleanAll();
  });
  it('loadData should create Load and LOAD_SUCCESS actions and return Promise', () =&gt; {
    const expectedActions = [
      load('data'),
      loadSuccess('data', data)
    ];
    const store = setup();
    return store.dispatch(loadData())
      .then((action) =&gt; {
        expect(action).toEqual(loadSuccess('data', data));
        expect(store.getActions()).toEqual(expectedActions);
      });
  });
});

</code></pre>

<h2>
<a id="action-and-state" class="anchor" href="#action-and-state" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Action and state</h2>

<ul>
<li>
<p>action</p>

<ul>
<li>LOAD: data loading for particular key is started</li>
<li>LOAD_SUCCESS: data loading process successfully finished. You'll have data returned from promise</li>
<li>LOAD_FAIL: data loading process was failed. You'll have error returned from promise</li>
</ul>
</li>
<li>
<p>state</p>

<ul>
<li>[key]: Data, returned from resolved promise</li>
<li>loadState.[key].loading: [key].loading </li>
<li>loadState.[key].loaded: Identifies that promise was resolved</li>
<li>loadState.[key].error: Errors, returned from rejected promise</li>
<li>loadingNumber: Number of loading</li>
</ul>
</li>
</ul>

<h2>
<a id="api" class="anchor" href="#api" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>API</h2>

<ul>
<li><p><code>asyncMiddleware</code>: Redux Middleware</p></li>
<li>
<p><code>[ASYNC]</code></p>

<ul>
<li>
<code>key</code>: String</li>
<li>
<code>promise(store)</code>: Function =&gt; Promise

<ul>
<li>
<code>store</code>(Option): Object</li>
</ul>
</li>
<li>
<code>once</code>: Bool</li>
</ul>
</li>
<li>
<p><code>reducerCreator(reducers)</code>: Function =&gt; Reducer</p>

<ul>
<li>
<code>reducers</code>(Option): Object</li>
</ul>
</li>
</ul>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>License</h2>

<p>MIT</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/lewis617/redux-amrc">Redux-amrc</a> is maintained by <a href="https://github.com/lewis617">lewis617</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
